<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>ParabÃ©ns pela compra!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background-color: #075E54;
      color: #FFFFFF;
      font-family: 'Segoe UI', 'Roboto', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    .contador {
      font-size: 3rem;
      font-weight: bold;
      color: #25D366;
      margin-top: 20px;
    }
    .check {
      font-size: 4rem;
      color: #25D366;
      display: none;
    }
  </style>

  <!-- Pixel do Facebook -->
  <script>
    !function(f,b,e,v,n,t,s){
      if(f.fbq)return;n=f.fbq=function(){
        n.callMethod ?
        n.callMethod.apply(n,arguments) : n.queue.push(arguments)
      };
      if(!f._fbq)f._fbq=n;
      n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)
    }(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');

    fbq('init', '1124756639573111');

    // âœ… LÃ³gica adicionada para restaurar _fbc do localStorage
    (function ensureFbcCookie() {
      const hasFbc = document.cookie.includes('_fbc=');
      if (!hasFbc) {
        const fbclid = localStorage.getItem('fbclid');
        if (fbclid) {
          const timestamp = Math.floor(Date.now() / 1000);
          const fbcValue = `fb.1.${timestamp}.${fbclid}`;
          document.cookie = `_fbc=${fbcValue}; path=/; domain=${location.hostname}; SameSite=Lax`;
          console.log('âœ… Cookie _fbc recriado a partir do localStorage.');
        }
      }
    })();

    function getValorCompra() {
      const params = new URLSearchParams(window.location.search);
      const valor = parseFloat(params.get("valor"));
      return isNaN(valor) ? 1.00 : valor;
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return '';
    }

    function sendApiEvent(eventId, valor) {
      const fbp = getCookie('_fbp');
      const fbc = getCookie('_fbc');
      const userAgent = navigator.userAgent;

      const bodyData = {
        event_name: 'Purchase',
        event_id: eventId,
        event_time: Math.floor(Date.now() / 1000),
        action_source: 'website',
        event_source_url: window.location.href,
        user_data: {
          fbp: fbp,
          fbc: fbc,
          client_user_agent: userAgent,
        },
        custom_data: {
          currency: 'BRL',
          value: valor
        }
      };

      fetch('https://acebook-conversion-api.onrender.com/purchase', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(bodyData)
      });
    }

    // --- LÃ³gica Anti-Duplicidade com cookie + sessionStorage ---
    const valorCompra = getValorCompra();
    const sessionKey = 'conversionData';
    let sessionData = sessionStorage.getItem(sessionKey);
    const alreadySent = document.cookie.includes('conversionSent=true');

    if (!sessionData && !alreadySent) {
      const uniqueEventId = Date.now().toString() + '-' + Math.random().toString(36).substring(2);

      fbq('track', 'Purchase',
        { value: valorCompra, currency: 'BRL' },
        { eventID: uniqueEventId }
      );

      sendApiEvent(uniqueEventId, valorCompra);

      sessionStorage.setItem(sessionKey, JSON.stringify({
        sent: true,
        event_id: uniqueEventId
      }));

      document.cookie = 'conversionSent=true; max-age=3600; path=/'; // Cookie por 1 hora
    } else {
      console.log('ConversÃ£o jÃ¡ registrada nesta sessÃ£o ou cookie. Ignorando.');
    }
    // --- Fim da lÃ³gica anti-duplicidade ---
  </script>

  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=1124756639573111&ev=PageView&noscript=1"/>
  </noscript>
</head>

<body>
  <h1>ðŸŽŠParabÃ©ns pela compraðŸŽŠ</h1>
  <p>Acesso liberado em...</p>
  <div class="contador" id="contador">3</div>
  <div class="check" id="check">âœ”</div>

  <script>
    const link = `https://drive.google.com/drive/folders/1cbkxxah91v0QEX-436Qh8h80geOBauwL?usp=drive_link`;
    let segundos = 3;
    const contador = document.getElementById("contador");
    const check = document.getElementById("check");

    const interval = setInterval(() => {
      segundos--;
      if (segundos > 0) {
        contador.textContent = segundos;
      } else {
        clearInterval(interval);
        contador.style.display = "none";
        check.style.display = "block";
        setTimeout(() => {
          window.location.href = link;
        }, 1000);
      }
    }, 1000);
  </script>
</body>
</html>
